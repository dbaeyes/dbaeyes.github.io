<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="在遙遠的地方 一切虔誠終必相遇">

    <title>statspack性能调整与扩展 - Microdust</title>

    <link rel="canonical" href="http://dbaeyes.github.io/oracle/statspack-performance-adjustment-and-expansion.html">

    <!-- Icons -->
  <link rel="shortcut icon" href="img/favicon.ico">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Microdust</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/About.html">About</a>
                </li>
                
                <li>
                    <a href="/Lists.html">Reading</a>
                </li>
                
                <li>
                    <a href="/Tools.html">Tools</a>
                </li>
                
                <li>
                    <a href="/tags.html">Tags</a>
                </li>
                
                <li>
                    <a href="/photos/Instagram/">Photos: Instagram</a>
                </li>
                
                <li>
                    <a href="/photos/">Photos</a>
                </li>
                

            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/fantasy.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="Tags">
                        
                        <a class="tag" href="/Tags/#oracle" title="oracle">oracle</a>
                        
                    </div>
                    <h1>statspack性能调整与扩展</h1>
                    
                    <span class="meta">Posted by {"login"=>"Toby", "email"=>"renwei.chu@gmail.com", "display_name"=>"David", "first_name"=>"", "last_name"=>""} on October 14, 2008</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container">

                <p><strong>一、前言</strong></p>
<div>
<p><span style="font-family: 'Times New Roman';">Oracle statspack</span>从<span style="font-family: 'Times New Roman';">oracle 816</span>开始被引进，因为其强大的功能，是<span style="font-family: 'Times New Roman';">DBA</span>与<span style="font-family: 'Times New Roman';">ORACLE</span>专家用来对数据库性能进行调整的强有力的工具。也有众多的文章已经写到了用<span style="font-family: 'Times New Roman';">statspack</span>进行性能调整，优化。这里，我仅仅在<span style="font-family: 'Times New Roman';">Oracle 9i</span>在<span style="font-family: 'Times New Roman';">Linux</span>上的进一步扩充<span style="font-family: 'Times New Roman';">statspack</span>，并利用了<span style="font-family: 'Times New Roman';">9i</span>的新功能与<span style="font-family: 'Times New Roman';">OS</span>的监控命令，如果以下不做特殊说明，都假定数据库的版本是<span style="font-family: 'Times New Roman';">9.2</span>，操作系统是<span style="font-family: 'Times New Roman';">Redhat AS 2.1</span>。</p>
<p><strong>二、准备工作与</strong><strong><span style="font-family: 'Times New Roman';">statspack</span></strong><strong>的安装</strong></p>
<p><span style="font-family: 'Times New Roman';">1</span>、设置与<span style="font-family: 'Times New Roman';">statspack</span>相关的初始化参数</p>
<p>作业队列</p>
<p><span style="font-family: 'Times New Roman';">alter system set job_queue_processes=6 scope=both</span></p>
<p>时间统计，<span style="font-family: 'Times New Roman';">9i</span>默认是<span style="font-family: 'Times New Roman';">true</span></p>
<p><span style="font-family: 'Times New Roman';">alter system set timed_statistics=true scope=both</span></p>
<p><span style="font-family: 'Times New Roman';">2</span>、安装与删除</p>
<p><span style="font-family: 'Times New Roman';">statspack</span>在使用前，必须安装，安装文件位于<span style="font-family: 'Times New Roman';">$ORACLE_HOME/rdbms/admin</span>下，与此对应的还有很多其他的文件，如</p>
<p><span style="font-family: 'Times New Roman';">[oracle@db admin]$ ls sp*</span></p>
<p><span style="font-family: 'Times New Roman';">spcpkg.sql    spctab.sql   spdtab.sql sppurge.sql   sprepsql.sql spup816.sql spauto.sql     spcreate.sql spcusr.lis spdrop.sql spdusr.lis sprepins.sql sptrunc.sql   spup817.sql     spcpkg.lis     spctab.lis   spcusr.sql spdtab.lis spdusr.sql spreport.sql spuexp.par    spup90.sql</span></p>
<p>其中包括我们安装<span style="font-family: 'Times New Roman';">statspack</span>需要用到的<span style="font-family: 'Times New Roman';">spcreate.sql</span>，卸载需要用到的<span style="font-family: 'Times New Roman';">spdrop.sql</span>，清除记录需要用到的<span style="font-family: 'Times New Roman';">aptrunc.sql</span>等。</p>
<p>下面，我们就开始安装<span style="font-family: 'Times New Roman';">statspack</span>，在次之前我们必须用系统用户登录。</p>
<p>&nbsp;</p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;connect sys/pass as sysdba</span></p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;@$ORACLE_HOME/rdbms/admin/spcreate.sql</span></p>
<p>我们需要输入三个值：用户密码，用户默认表空间与用户临时表空间</p>
<p>&nbsp;</p>
<p>如果需要删除刚才的安装，也必须用系统用户登陆，并断开所有的<span style="font-family: 'Times New Roman';">perfstat</span>用户的连接，然后执行</p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;@$ORACLE_HOME/rdbms/admin/spdrop.sql</span></p>
<p>如果是仅仅想清除表中的统计数据，执行如下语句即可</p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;@$ORACLE_HOME/rdbms/admin/sptrunc.sql</span></p>
<p>或者直接删除表<span style="font-family: 'Times New Roman';">STATS$SNAPSHOT;</span>的数据，其他的表会级联删除。</p>
<p>&nbsp;</p>
<p><strong>三、</strong><strong><span style="font-family: 'Times New Roman';">statspack</span></strong><strong>的使用</strong></p>
<p><span style="font-family: 'Times New Roman';">1</span>、运行快照与性能报表</p>
<p><span style="font-family: 'Times New Roman';">statspack</span>的使用很简单，先必须执行<span style="font-family: 'Times New Roman';">statspack.snap</span>来生成快照，如果有两次以上快照，就可以运行<span style="font-family: 'Times New Roman';">spreport.sql</span>来得到性能报表了</p>
<p>如</p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;connect perfstat/pass</span></p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;execute statspack.snap</span></p>
<p>尽量使两次快照处于业务高峰时期，这样就可以得到业务高峰时期的性能报告，或者我们可以让快照定时执行，如半小时执行一次，这样的话，我们就可以选择其中的任意两个快照得到这个时间段的性能报表。</p>
<p>通过如下命令，我们就可以得到性能报表了</p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;connect perfstat/pass</span></p>
<p><span style="font-family: 'Times New Roman';">SQL&gt;@$ORACLE_HOME/rdbms/admin/spreport.sql</span></p>
<p>运行该脚本的时候，必须按找要求数据两个快照<span style="font-family: 'Times New Roman';">ID</span>，和一个报表文件名。系统将自动得到性能报表到指定的文件。</p>
<p>&nbsp;</p>
<p><span style="font-family: 'Times New Roman';">2</span>、定时运行快照脚本</p>
<p>快照可以通过数据库的<span style="font-family: 'Times New Roman';">DBMS_JOB</span>来定时执行，如<span style="font-family: 'Times New Roman';">spauto.sql</span>文件</p>
<p><span style="font-family: 'Times New Roman';">variable jobno number;</span></p>
<p><span style="font-family: 'Times New Roman';">variable instno number;</span></p>
<p><span style="font-family: 'Times New Roman';">begin</span></p>
<p><span style="font-family: 'Times New Roman';">select instance_number into :instno from v$instance;</span></p>
<p><span style="font-family: 'Times New Roman';">dbms_job.submit(:jobno, 'statspack.snap;', trunc(sysdate+1/24,'HH'), 'trunc(SYSDATE+1/24,''HH'')', TRUE, :instno);</span></p>
<p><span style="font-family: 'Times New Roman';">commit;</span></p>
<p><span style="font-family: 'Times New Roman';">end;</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Times New Roman';">1/24,HH   </span>一个小时执行一次</p>
<p><span style="font-family: 'Times New Roman';">1/48,MI   </span>半个小时执行一次</p>
<p><span style="font-family: 'Times New Roman';">1/144,MI </span>十分钟执行一次</p>
<p><span style="font-family: 'Times New Roman';">1/288,MI </span>五分钟执行一次</p>
<p>&nbsp;</p>
<p>当然，我们也可以通过<span style="font-family: 'Times New Roman';">OS</span>来完成。先完成如下脚本</p>
<p><span style="font-family: 'Times New Roman';">[oracle@db worksh]$ more autosnap.sh</span></p>
<p><span style="font-family: 'Times New Roman';">#!/bin/sh</span></p>
<p><span style="font-family: 'Times New Roman';"># auto exec statspack.snap</span></p>
<p><span style="font-family: 'Times New Roman';">ORACLE_BASE=/u01/product;export ORACLE_BASE</span></p>
<p><span style="font-family: 'Times New Roman';">ORACLE_HOME=$ORACLE_BASE/oracle9i;export ORACLE_HOME</span></p>
<p><span style="font-family: 'Times New Roman';">PATH=$ORACLE_HOME/bin:$PATH;export PATH</span></p>
<p><span style="font-family: 'Times New Roman';">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib; export LD_LIBRARY_PATH</span></p>
<p><span style="font-family: 'Times New Roman';">ORACLE_SID=ora81; export ORACLE_SID</span></p>
<p><span style="font-family: 'Times New Roman';">ORACLE_NLS=$ORACLE_HOME/ocommon/nls/admin/data; export ORACLE_NLS</span></p>
<p>&nbsp;</p>
<p><span style="font-family: 'Times New Roman';"># start exec procedure</span></p>
<p><span style="font-family: 'Times New Roman';">sqlplus /nolog&lt;&lt; EOF</span></p>
<p><span style="font-family: 'Times New Roman';">connect perfstat/pass</span></p>
<p><span style="font-family: 'Times New Roman';">exec statspack.snap;</span></p>
<p><span style="font-family: 'Times New Roman';">exit;</span></p>
<p><span style="font-family: 'Times New Roman';">EOF</span></p>
<p>然后通过<span style="font-family: 'Times New Roman';">crontab –e</span>编辑调用文件</p>
<p><span style="font-family: 'Times New Roman';">0,30 * * * * /u01/product/work/worksh/autosnap.sh&gt;&gt;/u01/product/work/logs/snap.log 2&gt;&amp;1</span></p>
<p>表示每半小时执行一次，日志与错误信息记载到<span style="font-family: 'Times New Roman';">snap.log</span>中</p>
<p>&nbsp;</p>
<p>四、分析性能报告<br />
运行spreport.sql之后，就得到了我们需要的性能报表，但是这个报表怎么看呢？仍然是许多人为之头疼的问题。下面就简单的解释一下性能报表的分析方法。<br />
1、Instance Efficiency Percentages<br />
Data Buffer Hit Ratio#&lt;#90#数据块在数据缓冲区中的命中率，通常应该在90%以上，否则考虑加大 db_block_buffers(9i 以上可是db_cache_size)<br />
Buffer Nowait Ratio#&lt;#99#在缓冲区中获取buffer 的未等待比率<br />
Library Hit Ratio#&lt;#98#主要代表着sql在共享区的命中率，通常在98%以上<br />
In Memory Sort Ratio#&lt;#0#如果过低说明有大量的排序在临时表空间中进行，可尝试增加sort_area_size<br />
Redo Nowait Ratio#&lt;#98#写日志的不等待比率,太低可调整log_buffer(增加)和 _log_io_size(减小，默认为1/3*log_buffer/log_block_size,使得 _log_io_size 为合适的值，比如128k/log_block_size)<br />
Soft Parse Ratio#&lt;#90#近似当作sql在共享区的命中率，通常高代表使用了绑定变量,太低需要调整应用使用绑定变量，或者参考 cursor_sharing = force (9i 中增加了 similar )<br />
Latch Hit Ratio#&lt;#99#内部结构维护锁命中率，高于99%,通常低是因为shared_pool_size过大和没有使用绑定变量导致硬解析过多，可参考 _spin_count 参数设置<br />
Percent Non-Parse CPU#&lt;#95#查询实际运行时间/(查询实际运行时间+sql解析时间)，太低表示解析消耗时间过长<br />
Percent Parse CPU to Parse Elapsed#&lt;#90#解析实际所用时间/(解析实际所用时间+解析中等待资源时间),越高越好<br />
Execute to Parse Percent#&lt;#10#该值越高表示一次解析后被重复执行的次数越多，如果过低可以考虑设置 session_cached_cursors &gt; 0<br />
Memory Usage Percent#&lt;#75#共享池的使用率，应该稳定在75%--90%之间，太小浪费内存，太大则显内存不足<br />
Percent of SQLs with Execution&gt;1#&lt;#40#执行次数大于1的sql的比率（若太小可能是没有使用绑定变量）<br />
Percent of Memory for SQl with Execution&gt;1#&lt;#0#执行次数大于1的sql消耗内存/(所有sql消耗内存)</p>
<p>2、Instance Load Profile<br />
Redo Size/Sec#&gt;#100000#每秒产生的日志大小（单位字节），可标志数据库任务的繁重与否<br />
Redo Size/Tx#&gt;#0#平均每个事务的日志生成量<br />
Logical Reads/Sec(逻辑读)#&gt;#0#平均每秒产生的逻辑读,单位是block<br />
Logical Reads/Tx#&gt;#0#平均每个事务产生的逻辑读,单位是block<br />
Block Changes/Sec#&gt;#100#每秒block变化数量，数据库事务带来改变的块数量<br />
Block Changes/Tx#&gt;#0#平均每个事务所导致的改变的块数<br />
Physical Reads/Sec#&gt;#100#平均每秒数据库从磁盘读取的block数<br />
Physical Reads/Tx#&gt;#0#平均每个事务从磁盘读取的block数<br />
Physical Write/Sec#&gt;#50#平均每秒写磁盘的block数<br />
Physical Write/Tx#&gt;#0#平均每个事务写磁盘的block数<br />
User Calls/Sec#&gt;#0#每秒用户call次数<br />
User Calls/Tx#&gt;#0#每事务用户call次数<br />
Parses/Sec#&gt;#100#每秒解析次数，近似反应了每秒语句的执行次数<br />
Parses/Tx#&gt;#0#每事务产生的解析次数<br />
Hard Parses/Sec#&gt;#10#每秒产生的硬解析次数<br />
Hard Parses/Tx#&gt;#0#每事务产生的硬解析次数<br />
Sorts/Sec#&gt;#20#每秒产生的排序次数<br />
Sorts/Tx#&gt;#5#每事务产生的排序次数<br />
Transactions/Sec#&gt;#0#每秒产生的事务数<br />
Rows/Sort#&gt;#0#每次排序所涉及到的行数<br />
Percent of Block Changed/Read#&gt;#0#发生变化的块数/读次数，变化的块需要从回滚段来数据<br />
Recursive Call Percent#&gt;#0#递归操作占所有操作的比率<br />
Rollback/Tx Percent#&gt;#5#事务回滚率（回滚开销很大）<br />
Executes/Sec#&gt;#0#每秒执行次数<br />
Execute/Tx#&gt;#0#每个事务执行次数</p>
<p>3、I/O Statistics(I/O统计数据)<br />
Table Space I/O#&gt;#0#表示各表空间在IO上的分布，若出现严重不均衡，则要重新考虑对象的存储规划和表空间中数据文件的磁盘规划<br />
Datafile I/O#&gt;#0#表示各数据文件的IO分布，若不均衡则需要重新考虑对象的存储规划<br />
Table I/O（表I/O）#&gt;#0#对这些IO很大的表，要考虑放置在高速磁盘上，并且尽可能的分布在不同的磁盘上</p>
<p>4、TOP SQL<br />
Top SQL with High Buffer Gets#&gt;#0#这类sql进行了大量的block的读，要检查该sql是否用到了索引，或者说表上是否存在合理的索引，对于必须全表扫描的大表可以考虑recycle buffer ,对于频繁进行全表扫描的小表可以考虑keep buffer，还有一种需要注意的情况就是如果通过索引获取数据比例占表数据比例过大，比如20%(举例数据)，就能导致buffer gets过大<br />
Top SQL with High Physical Reads#&gt;#0#这类sql导致了大量的从磁盘获取数据，可能因为数据缓冲区太小，也可能是过多的全表扫描，需要考察索引是否合理，是否用到索引<br />
Top SQL with High Execution Count#&gt;#0#这类sql是需要重点关注的，也许这些sql本身一次执行并没有消耗大量的时间或者空间，但由于频繁的执行对系统影响极大，所以只要有优化的可能到要对这些sql进行优化。还有另外一些情况，就是某些程序中可能大量频繁地使用dual表来获取一些信息(比如时间的计算等)，尽可能的使这类sql转化为应用本地能解决的函数，或者还存在一些由于设计上的缺陷导致不必要的查询，都要在设计的角度避免这些查询<br />
Top SQL with High Shared Memory#&gt;#0#这类sql使用了大量的内存，不一定执行的频繁，但是它可能把执行的频繁的sql涉及的一些数据挤出缓冲区，这同样将导致很多问题，所以也需要从尽可能的优化<br />
Top SQL with High Version Count#&gt;#20#表示多个用户的sql在字面上是一样的，或者sql虽然一样但是session的一些参数发生了改变（比如sort_area_size发生了变化）</p>
<p>5、Wait Events(等待事件)<br />
ORACLE的等待事件是衡量Oracle性能的重要依据与指标，Oracle从7.0就开始引入等待时间，到8i已经有近200个，到9i已经近360个等待事件了，等待事件也分为两种，空闲等待事件与非空闲等待事件。<br />
空闲等待事件是表示Oracle在等待某项工作，在性能调整的时候，我们可以不用注意这类等待事件，空闲事件被列于stats$idle_event 表中，常见的空闲等待事件有：<br />
dispatcher timer<br />
lock element cleanup<br />
Null event<br />
parallel query dequeue wait<br />
parallel query idle wait – Slaves<br />
pipe get<br />
PL/SQL lock timer<br />
Pmon timer – pmon<br />
rdbms ipc message<br />
slave wait<br />
smon timer<br />
SQL *Net break/reset to client<br />
SQL *Net message from client<br />
SQL *Net message to client<br />
SQL *Net more data to client<br />
virtual circuit status<br />
client message<br />
非空闲等待事件专门针对Oracle的活动，指在运行数据库任务或者是应用程序任务时发生等待，这类等待事件是我们在性能调整的时候必须注意的。常见的等待事件有：<br />
db file scattered read<br />
db file sequential read<br />
buffer busy waits<br />
free buffer waits<br />
enqueue<br />
latch free<br />
log file parallel write<br />
log file sync</p>
<p>下面，就大部分常见等待时间做一个简单的解释，大家可以着重注意以上等待事件。<br />
alter system set mts_dispatcher#&gt;#0#当会话决定执行"ALTER SYSTEM SET MTS_DISPATCHERS = &lt;string&gt; "的时候等待DISPATCHERS的启动<br />
BFILE check if exists#&gt;#0#检查外部的bfile文件是否存在<br />
BFILE check if open#&gt;#0#检查外部的bfile文件是否已经open<br />
BFILE closure#&gt;#0#等待关闭外部bfile文件<br />
BFILE get length#&gt;#0#获得外部bfile文件的大小<br />
BFILE get name object#&gt;#0#得到外部bfile文件的名字<br />
BFILE get path object#&gt;#0#得到外部bfile文件的路径<br />
BFILE open#&gt;#0#等待外部bfile被打开<br />
BFILE read#&gt;#0#等待外部bfile文件读取完毕<br />
buffer busy waits#&gt;#0#block正被读入缓冲区或者缓冲区正被其他session使用,出现此情况通常可能通过几种方式调整：增大data buffer,增加freelist，减小pctused,增加回滚段数目，增大initrans,考虑使用LMT<br />
buffer deadlock#&gt;#0#由于系统缓慢所产生而非应用产生了死锁<br />
buffer latch#&gt;#0#会话等待'buffer hash chain latch'<br />
buffer read retry#&gt;#0#OPS下读buffer的过程中内容发生了变化于是重新读取<br />
completed#&gt;#0#等待检查点的完成，通常出现这个问题的原因是IO问题严重，可调整跟检查点相关参数log_checkpoint_interval, log_checkpoint_timeout, db_block_max_dirty_target, fast_start_io_target 等，可间接的增大日志文件大小和增加日志文件组数<br />
control file parallel write#&gt;#0#等待写所有控制文件的完成，可将控制文件分散在不同的磁盘上<br />
control file sequential read#&gt;#0#读控制文件，在备份控制文件、OPS等情况下产生<br />
control file single write#&gt;#0#OPS下同一时刻只允许一个session将共享信息写入磁盘<br />
db file parallel read#&gt;#0#做恢复的并行从数据文件获取数据<br />
db file parallel write#&gt;#0#当多个IO可以同时发生时(多磁盘)，DBWR可并行写入，DBWR等待最后一个IO的完成<br />
db file scattered read#&gt;#0#一次获取的block被分散在buffer的不连续空间中，通常表示全表扫描过多，可检查应用程序是否合理的使用了索引，数据库是否合理的创建了索引<br />
db file sequential read#&gt;#0#通常暗示着通过索引获取数据量比较大（比如通过索引进行范围扫描获取表数据百分比过大），多表连接的时候连接顺序不当，hash join时hash_area_size无法容纳hash table<br />
db file single write#&gt;#0#更新数据文件头出现等待<br />
DFS db file lock#&gt;#0#OPS下每个实例在数据文件上有一个共享的全局锁，当要offline数据文件的时候等候其他实例同步文件<br />
DFS lock handle#&gt;#0#会话等待一个全局锁请求<br />
direct path read#&gt;#0#通常发生在临时表空间排序、并行查询中<br />
direct path write#&gt;#0#direct方式导入数据(sqlldr,CTAS)、PDML、临时表空间排序<br />
enqueue#&gt;#0#对共享资源的获取要求一种排队(FIFO)的机制以保护共享资源，ST enqueue表示空间分配或者释放导致的问题可采用LMT表空间来避免，TX enqueue主要产生于唯一索引重复、bitmap index 的频繁更新、initrans太小或者pctfree过小<br />
free buffer waits#&gt;#0#在缓冲区中寻找可用buffer出现等待，可能数据缓冲区太小，也可能检查点间隔太长，也可能频繁的DML而IO成为瓶颈<br />
free global transaction table entry#&gt;#0#分布式数据库中会话等待一个全局事务槽<br />
global cache lock busy#&gt;#0#会话等待将一个buffer从当前共享状态转换为当前独占状态<br />
index block split#&gt;#0#当在索引中查找一个key的时候如果发现该索引block正在裂变则等待裂变完成<br />
io done#&gt;#0#会话等待IO的完成<br />
latch free#&gt;#0#是一种维护内存的锁，不采用排队机制，快速的获取然后很快释放，造成的原因通常有程序没有使用绑定变量、shared_pool_size设置过大（比如1G）、LRU竞争、某些块过热（访问太频繁）<br />
LGWR wait for redo copy#&gt;#0#表示等待redo allocation and redo copy latches,可增加 _log_simulteneous_copies(默认为 2*CPUs)，但同时也容易引入redo allocation latch contention,所以需要慎重<br />
log buffer space#&gt;#0#生成日志等待lgwr赶快写文件而腾出log buffer,可在init参数文件中增大 log_buffer,放置日志文件于高速磁盘上<br />
log file parallel write#&gt;#0#当lgwr写日志文件的过程中出现等待，这个等待通常会导致 log file sync事件,放置日志文件于高速磁盘上<br />
log file switch (archiving needed)#&gt;#0#当日志切换的时候由于日志组循环使用了一圈但日志归档还没有完成，通常是io有严重问题，可增大日志文件和增加日志组，调整log_archive_max_processes<br />
log file switch (checkpoint incomplete)#&gt;#0#当日志切换的时候由于日志组循环使用了一圈但将被使用的日志组中的checkpoint还没有完成造成，通常是io有严重问题，可增大日志文件和增加日志组<br />
log file sync#&gt;#0#当用户commit的时候通知lgwr写日志但lwgr正忙，造成的可能原因是commit太频繁或者lgwr一次写日志时间太长（可能是因为一次log io size 太大），可调整 _log_io_size，结合log_buffer,使得 (_log_io_size*db_block_size)*n = log_buffer,这样可避免和增大log_buffer引起冲突;放置日志文件于高速磁盘上<br />
write complete waits#&gt;#0#用户等候buffer被写进文件，暗示着写回滚段的时候有着等待，需要调整回滚段，包括合理的回滚段数量和大小，回滚段位于高速磁盘</p>
<p>&nbsp;</p>
<p>五、调整statspack的收集门限<br />
1、级别<br />
statspack的级别用来设置收集数据的类型，statspack一般有三种级别设置，默认是5。<br />
Level 0：一般性能统计，包括等待时间、系统事件、系统统计、回滚段统计、行缓存、SGA、会话、锁、缓冲池统计等等。<br />
Level 5：增加SQL语句的收集，除了level 0的所有内容，还包括SQL语句的收集，收集结果记录在stat$Sql_summary中<br />
Level 10：增加子锁存统计，包括level 5的所有内容，并且将附加的子锁存保存到stats$lachc_children表中，使用这个级别的时候需要慎重，最好在Oracle support的指导下进行<br />
如果想永久的修改收集级别，可以<br />
SQL&gt;execute statspack.snap(i_snap_level=&gt;0,i_modify_parameter=&gt;’true’);<br />
如果仅仅是想修改本次的收集级别，省略i_modify_parameter参数即可<br />
SQL&gt;execute statspack.snap(i_snap_level=&gt;0);<br />
2、门限<br />
statspack的快照用来设置收集数据的阀值<br />
快照门限只应用于stats$sql_summary中收集的SQL语句，因为每一个快照就会收集很多数据，特别是stats$sql_summary，很快就会成为最大的表。<br />
门限存储在stats$statspack_parameter表中，让我们了解一下各个门限值。<br />
Executions_th   这是SQl语句执行的的次数（默认100）<br />
Disk_reads_th   这是SQL语句磁盘读入块的数量（默认1000）<br />
Parse_calls_th   这是SQL语句执行解析调用的次数（默认1000）<br />
Buffer_gets_th 这是SQL语句执行缓冲区获取数量（默认是10000）<br />
任何超过这个门限的SQL语句都将被记载下来<br />
我们可以通过statspack.modify_statspcak_parameter函数来修改门限值<br />
SQL&gt;execute statspack.modify_statspcak_parameter(i_ buffer_gets_th=1000);</p>
<p>六、获得更多的OS的信息<br />
1、利用vmstat进行性能监控<br />
先利用以下脚本获取OS信息并保存到磁盘<br />
[oracle@db worksh]$ more autovmstat.sh<br />
#/bin/sh<br />
#sample every five minutes(300s)</p>
<p>SIMPLE_TIME=300<br />
SIMPLE_NUMS=1</p>
<p>while true<br />
do<br />
DATE=`date +%Y-%m-%d:%H:%M:%S`<br />
OSPROCESS= `ps -ef|wc -l`</p>
<p>vmstat ${SIMPLE_TIME} ${SIMPLE_NUMS} &gt;/tmp/vmmsg<br />
#get file info<br />
cat /tmp/vmmsg|sed 1,2d|\<br />
awk '{printf("%s %s %s %s %s %s %s %s %s %s %s %s %s %s %s %s\n",$1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16)}'|\<br />
while read R1 B1 W1 SWPD1 FREE1 BUFF1 CACHE1 SI1 SO1 BI1 BO1 IN1 CS1 US1 SY1 ID1<br />
do<br />
echo $DATE","$R1","$B1","$W1","$SWPD1","$FREE1","$BUFF1","$CACHE1","$SI1","$SO1","$BI1","$BO1","$IN1","$CS1","$US1","$SY1","$ID1","$OSPROCESS \<br />
&gt;&gt;/u01/product/work/logs/osvmstat.txt<br />
done<br />
done</p>
<p>rm -f /tmp/vmmsg</p>
<p>2、建立9i外部表<br />
先需要创建目录并授权<br />
SQL&gt; CREATE DIRECTORY VMDIR AS '/u01/product/work/logs/';<br />
SQL&gt; GRANT READ ON DIRECTORY VMDIR TO PERFSTAT;<br />
SQL&gt; GRANT WRITE ON DIRECTORY VMDIR TO PERFSTAT;<br />
然后再建立外部表<br />
create table STATS$VMSTAT<br />
(<br />
SNAP_TIME VARCHAR2(20),<br />
R         NUMBER,<br />
B         NUMBER,<br />
W         NUMBER,<br />
SWPD      NUMBER,<br />
FR        NUMBER,<br />
BUFF      NUMBER,<br />
CA        NUMBER,<br />
SI        NUMBER,<br />
SO        NUMBER,<br />
BI        NUMBER,<br />
BO        NUMBER,<br />
INTER     NUMBER,<br />
CS        NUMBER,<br />
US        NUMBER,<br />
SY        NUMBER,<br />
ID        NUMBER,<br />
OP        NUMBER<br />
)<br />
ORGANIZATION EXTERNAL<br />
(TYPE ORACLE_LOADER<br />
DEFAULT DIRECTORY VMDIR<br />
ACCESS PARAMETERS(RECORDS DELIMITED BY NEWLINE<br />
FIELDS TERMINATED BY ',')<br />
LOCATION('osvmstat.txt'))</p>
<p>然后就可以向访问普通表一样访问OS文件了。根据vmstat获得的信息，我们也可以得到很多辅助的报告。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>七、解决扩展statspack应用中的快照不连续问题<br />
在有些情况下，snap_id会出现不连续情况，如<br />
SQL&gt; select t.snap_id,to_char(t.snap_time,'yyyy-mm-dd hh24:mi') from stats$snapshot t order by 1;<br />
……<br />
SNAP_ID TO_CHAR(T.SNAP_TIME,'YYYY-MM-D<br />
------- ------------------------------<br />
72 2003-08-04 06:00<br />
73 2003-08-04 06:30<br />
75 2003-08-04 07:00<br />
77 2003-08-04 07:30<br />
79 2003-08-04 08:00<br />
81 2003-08-04 08:30<br />
这是一个利用cron进程自动进行统计所产生的snap_id的情况，统计周期是半个小时。大家可以看到，其中的snap_id是不连续的。假如我有这样的语句，大家会发现，语句中红色部分在snap_id不连续的情况下，是有问题的.<br />
select to_char(snap_time,'yyyy-mm-dd hh24'),sum(read),sum(write) from<br />
(select sn.snap_time-1/48 snap_time,(newr.value-oldr.value) read,<br />
(neww.value-oldw.value) write<br />
from stats$sysstat newr,<br />
stats$sysstat oldr,<br />
stats$sysstat neww,<br />
stats$sysstat oldw,<br />
stats$snapshot sn<br />
where sn.snap_id=newr.snap_id<br />
and sn.snap_id=neww.snap_id<br />
and sn.snap_id-1=oldr.snap_id<br />
and sn.snap_id-1=oldw.snap_id<br />
and newr.name='physical reads'<br />
and oldr.name='physical reads'<br />
and neww.name='physical writes'<br />
and oldw.name='physical writes'<br />
) v<br />
group by to_char(snap_time,'yyyy-mm-dd hh24')</p>
<p>我们怎样解决这个问题，需要创建一个中间视图即可以解决问题<br />
1、给个权限<br />
grant create view to perfstat;<br />
2、创建一个视图<br />
CREATE OR REPLACE VIEW V_STATS$SNAPSHOT AS<br />
SELECT row_number() over (ORDER BY snap_id) id,<br />
t.* FROM stats$snapshot t</p>
<p>3、改写语句如下，注意红色部分，这样的话，就是不连续也没有关系了<br />
select to_char(snap_time,'yyyy-mm-dd hh24'),sum(read),sum(write) from<br />
(select sn.snap_time-1/48 snap_time,(newr.value-oldr.value) read,<br />
(neww.value-oldw.value) write<br />
from stats$sysstat newr,<br />
stats$sysstat oldr,<br />
stats$sysstat neww,<br />
stats$sysstat oldw,<br />
v_stats$snapshot sn<br />
where sn.snap_id=newr.snap_id<br />
and sn.snap_id=neww.snap_id<br />
and oldr.snap_id = (select snap_id from v_stats$snapshot where id = sn.id-1)<br />
and oldw.snap_id = (select snap_id from v_stats$snapshot where id = sn.id-1)<br />
and newr.name='physical reads'<br />
and oldr.name='physical reads'<br />
and neww.name='physical writes'<br />
and oldw.name='physical writes'<br />
) v<br />
group by to_char(snap_time,'yyyy-mm-dd hh24')</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>八、扩展statspack的使用<br />
好了，statspack也会使用了，性能报表也会分析了，我们能不能利用statspack做更多的活呢？当然是可以的了，这里就是需要我们讨论的statspack的扩展了，我们可以利用statspack做出直观的图表，可以利用上面vmstat的数据得到OS的性能，还可以把数据库的性能与操作系统的性能比较。<br />
1、利用stats$sysstat与每半小时一次的statspack分析，我们可以用如下语句得到数据文一天OS走势图：<br />
select to_char(snap_time,'yyyy-mm-dd hh24'),sum(read),sum(write) from<br />
(select sn.snap_time-1/48 snap_time,(newr.value-oldr.value) read,<br />
(neww.value-oldw.value) write<br />
from stats$sysstat newr,<br />
stats$sysstat oldr,<br />
stats$sysstat neww,<br />
stats$sysstat oldw,<br />
v_stats$snapshot sn<br />
where sn.snap_id=newr.snap_id<br />
and sn.snap_id=neww.snap_id<br />
and oldr.snap_id = (select snap_id from v_stats$snapshot where id = sn.id-1)<br />
and oldw.snap_id = (select snap_id from v_stats$snapshot where id = sn.id-1)<br />
and newr.name='physical reads'<br />
and oldr.name='physical reads'<br />
and neww.name='physical writes'<br />
and oldw.name='physical writes'<br />
) v<br />
group by to_char(snap_time,'yyyy-mm-dd hh24')<br />
拷贝查询的数据到excel，可以做出如下的图表</p>
<p>2、利用vmstat采集的数据与外部表，我们可以利用如下的SQL语句得到文件系统一天的IO走势图：<br />
select to_char(snap_time,'yyyy-mm-dd hh24') snap_time,<br />
round(avg(bo*4096)) write,<br />
round(avg(bi*4096)) read<br />
from<br />
(select to_date(snap_time,'yyyy-mm-dd hh24:mi:ss') snap_time,<br />
t.bi,t.bo from stats$vmstat t)<br />
group by to_char(snap_time,'yyyy-mm-dd hh24')<br />
拷贝查询结果到excel，可以得到如下图表</p>
<p>3、同理，根据statspack与vmstat的数据，我们可以获得os与db的进程数的图表</p>
<p>除此之外，我们可以得到很多其他的图表分析，如Data buffer命中率，CPU，内存使用率等等，同样，图表的时间也可以不仅仅局限于一天，可以是一周的IO走势图，甚至是一个月的IO走势图</p>
</div>


                <hr>


                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC A-S 4.0 International License</a>.

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/my%20life/night-time-is-a-bit-long.html" data-toggle="tooltip" data-placement="top" title="晚上工作的时间有点长">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/thinking/web&amp;rt/life-is-worth-keeping-80-words.html" data-toggle="tooltip" data-placement="top" title="人生值得珍藏的80句话">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- Duoshuo Share start -->
                <style>
                    .ds-share{
                        text-align: right;
                    }
                    
                    @media only screen and (max-width: 700px) {
                        .ds-share {

                        }
                    }
                </style>

                <div class="ds-share"
                    data-thread-key="/oracle/statspack-performance-adjustment-and-expansion" data-title="statspack性能调整与扩展"
                    data-images="http://dbaeyes.github.io/img/fantasy.jpg"
                    data-content="一、前言

Oracle statspack从oracle 816开始被引进，因为其强大的功能，是DBA与ORACLE专家用来对数据库性能进行调整的强有力... | Microdust:Azeril's blog"
                    data-url="http://dbaeyes.github.io/oracle/statspack-performance-adjustment-and-expansion.html">
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">

                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                <!-- Duoshuo Share end-->




                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread" data-thread-key="/oracle/statspack-performance-adjustment-and-expansion" data-title="statspack性能调整与扩展" data-url="http://dbaeyes.github.io/oracle/statspack-performance-adjustment-and-expansion.html"></div>
                </div>
                <!-- 多说评论框 end -->
            </div>
        </div>
    </div>
</article>



<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"azeril"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->



</script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>

  
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <!-- kill the Facebook and Weibo -->
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a href="https://twitter.com/Azeril_Lapland">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li>
                        <a href="https://github.com/Azeril">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <!--
                    
                    <li>
                        <a href="http://www.douban.com/people/Azeril">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-douban fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    -->

                    <!--
                    
                    <li>
                        <a href="https://www.facebook.com/Azeril_Lapland">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    -->

                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/Azeril">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    

                    <!--
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/Azeril">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    -->

                </ul>
                <p class="copyright text-muted">
                &copy; 2011~2016 David ♪ Powered by Jekyll.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>




<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js",function(){
        hljs.initHighlightingOnLoad();
    })
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


</body>

</html>