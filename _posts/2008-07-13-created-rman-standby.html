---
layout: post
title: RMAN 创建standby
date: 2008-07-13 00:30:44.000000000 +09:30
type: post
published: true
status: publish
categories:
- Oracle
tags:
- oracle
- rman
- standby
meta:
  posturl_add_url: 'yes'
  _edit_last: '1'
  views: '936'
---
<p>实验环境：windows + oracle 10.2.0.1.0</p>
<div>原数据库：dgtest[归档模式] 服务名：primary<br />
复制数据库：dgtest 服务名：standby</p>
<p>------------------------------------------<br />
参考文章：   http://xiecc.itpub.net/post/468/411898<br />
《oracle 高可用环境》</p>
<p>1. 查看主库环境， 归档模式，开启强制日志模式<br />
sql&gt; alter database force logging;</p>
<p>2. 在备库上创建同名实例，详细参看前面的 <a href="file:///D:/%E5%BE%AE%E4%BA%91%E7%BD%91%E7%9B%98/22194522/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/%E7%99%BE%E5%BA%A6blog-old/dbaeyes/blog/item/78d08d1fc6e5600f304e15bf.html" target="_blank">RMAN 复制数据库</a><br />
密码文件，目录等</p>
<p>3. 备份主库<br />
run<br />
{<br />
allocate channel c1 device type disk format 'c:/oracle/oraback/%U';<br />
backup database plus archivelog delete all input;<br />
}</p>
<p>备份 备用的控制文件<br />
RMAN&gt; run<br />
{<br />
allocate channel c1 device type disk format 'c:/oracle/oraback/%U';<br />
backup current controlfile for standby;<br />
}<br />
或者<br />
SQL&gt; alter database create standby controlfile as 'c:/oracle/oraback/control01.ctl';</p>
<p>复制备份集和备用控制文件到备库相应目录</p>
<p>4. 配置主库的tnsnames.ora文件， 配置备库的tnsnames.ora 和 listener.ora文件</p>
<p>5. 更新主库参数文件：</p>
<p>db_unique_name=dgtest<br />
<span style="font-family: 宋体;">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_CONFIG='DG_CONFIG=(tgtest,tgtest)'; --我的两个db_name一样，所以该项不用设置<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">SQL&gt; ALTER SYSTEM SET LOG_ARCHIVE_DEST_1='LOCATION=C:\oracle\product\arch VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=dgtest';<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">SQL&gt; LTER SYSTEM SET LOG_ARCHIVE_DEST_2='SERVICE=standby LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=dgtest'；<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">SQL&gt; ALTER SYSTEM SET FAL_SERVER=primary; --主库的service name<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">SQL&gt; ALTER SYSTEM SET FAL_CLIENT=standby;<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">SQL&gt; ALTER SYSTEM SET STANDBY_FILE_MANAGEMENT=AUTO;<br />
系统已更改。</span></p>
<p><span style="font-family: 宋体;">sql&gt; create pfile='' from spfile;</span></p>
<p><span style="font-family: 宋体;">拷贝pfile之备库，并做相应的修改</span></p>
<p><em><strong><span style="font-family: 宋体;">6.备库pfile：</span></strong></em></p>
<p><span style="font-family: 宋体;">主要参数：<br />
*.control_files='C:\oracle\product\10.2.0/oradata/dgtest/\standby1.ctl'<br />
*.log_archive_dest_1='LOCATION=C:\oracle\product\arch VALID_FOR=(ALL_LOGFILES,ALL_ROLES) DB_UNIQUE_NAME=dgtest'<br />
*.log_archive_dest_2='SERVICE=PRIMARY LGWR ASYNC VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=dgtest'<br />
</span></p>
<p>生成 spfile</p>
<p>7. 启动备库并恢复<br />
sql&gt; sqlplus "/ as sysdba"<br />
sql&gt; startup nomount<br />
sql&gt; alter database mount standby database;</p>
<p>恢复文件<br />
rman&gt; restore database;<br />
完成</p>
<p>8. 手动或者管理模式<br />
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE;<br />
SQL&gt; ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT FROM SESSION;</p>
<p>9. 验证备库<br />
查询库状态：<br />
SQL&gt; select name,open_mode,PROTECTION_MODE,DATABASE_ROLE from v$database;</p>
<p>Validate whether received：<br />
SQL&gt; SELECT SEQUENCE#, FIRST_TIME, NEXT_TIME<br />
FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#</p>
<p>Validate whethere new archive redo log have been applied.<br />
SQL&gt; select SEQUENCE#,DEST_ID,ARCHIVED,APPLIED,DELETED,<br />
STATUS from v$archived_log order by SEQUENCE#</p>
<p>SQL&gt; alter system archive log current;</p>
<p>-- EOF --</p></div>
